<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Yetibot: Developer Guide</title>
    <link rel="canonical" href="https://yetibot.com/dev-guide/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/main.css" rel="stylesheet" type="text/css" />

    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117101667-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-117101667-1');
    </script>
  </head>
  <body class="">


    <div class="main-content">
      <nav class="navbar is-black" role="navigation" aria-label="main navigation">
        <div class="container">
          <div class="navbar-brand">
            <a class="navbar-item" href="/">
              <img class="nav-logo" src="/img/yetibot_lambda_blue_with_grey.svg"
                                    alt="Yetibot: A powerful, expressive chatops platform written in Clojure."
                                    />
            </a>

            <div class="navbar-burger" data-target="nav-menu">
              <span></span>
              <span></span>
              <span></span>
            </div>

          </div>
          <div class="navbar-menu" id="nav-menu">
            <div class="navbar-start">
              
              <a href="/user-guide/"
                class="navbar-item ">
                User Guide
              </a>
              
              <a href="/dev-guide/"
                class="navbar-item is-active">
                Developer Guide
              </a>
              
              <a href="/ops-guide/"
                class="navbar-item ">
                Operations Guide
              </a>
              
              <a href="/community/"
                class="navbar-item ">
                Community
              </a>
              
              <a href="/media/"
                class="navbar-item ">
                Media
              </a>
              
              <a class="navbar-item " href="/archives/">Blog</a>
            </div>
          </div>
        </div>
      </nav>

      

<article class="page-title hero is-light is-bold is-fullwidth">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">Developer Guide</h1>
      <p class="subtitle">Yetibot internals and dev workflows</p>
    </div>
  </div>
</article>

<section class="section content">

  <div class="container">
    <div id="page">
      <div class="main columns">
        <div class="column page-content is-two-thirds">
          <p><!&ndash; can't indent this properly because Markdown turns it into a code block &ndash;> <article class="message is-info"> <div class="message-header">   <p>Tip</p> </div> <div class="message-body">   This guide is all about developing Yetibot. It includes docs about dev   workflow and Yetibot internals.</p><ul><li>If you're more interested using Yetibot, check out the out the  <a href='/user-guide'>User Guide</a>.</li><li>If you're interested in running and operating your own instance of Yetibot,  check out the <a href='/ops-guide'>Operations Guide</a>.</div></article></li></ul><p><article class="message is-info"> <div class="message-header">   <p>Getting help</p> </div> <div class="message-body">   Although we hope the docs are useful and comprehensive,   <strong>don't hesitate to ask for help in <a href='https://slack.yetibot.com'>Slack</a>!</strong>   It could potentially save you a lot of time. </div> </article></p><p><article class="message is-warning"> <div class="message-header">   <p>üößüööüë∑üèó</p> </div> <div class="message-body"> These docs are are work in progress. </div> </article></p><h2 id="dev&#95;workflow">Dev workflow</h2><h3 id="prerequisites">Prerequisites</h3><h4 id="leiningen">Leiningen</h4><p>Leiningen is the Clojure build tool that Yetibot uses. See the <a href='https://github.com/technomancy/leiningen#installation'>Leiningen Installation docs</a> to install it.</p><h4 id="postgres">Postgres</h4><p>Yetibot needs a Postgres database. It defaults to <code>yetibot</code> as the database name (this is configurable). Ensure you have Postgres installed, then create the database:</p><pre><code class="bash">createdb yetibot
</code></pre><p>The default connection string of <code>postgresql://localhost:5432/yetibot</code> should "just work".</p><h4 id="configuration">Configuration</h4><p>Make sure you've configured at least one chat adapter. This could be IRC or Slack. See <a href='http://localhost:4040/ops-guide/#minimal_config'>Up and running / minimal config</a> docs for a simple IRC example.</p><h3 id="repl">REPL</h3><p>Start up a development REPL with:</p><pre><code class="bash">lein repl
</code></pre><p>Then run:</p><pre><code class="clojure">&#40;start&#41;
</code></pre><p>To load a core set of commands and connect to any configured adapters.</p><p>At this point a typical dev workflow would be to iteratively write and reload code from your editor as is common in the Clojure community. See <a href='http://clojure-doc.org/articles/content.html#essentials'>Essentials</a> for docs on setting up various editors for Clojure development.</p><p>You can also optionally load all commands from the REPL using:</p><pre><code class="clojure">&#40;load-all&#41;
</code></pre><p>To fully reload and restart the adapters and database connections, use:</p><pre><code class="clojure">&#40;reset&#41;
</code></pre><p>And to stop, use:</p><pre><code class="clojure">&#40;stop&#41;
</code></pre><p>See source for <a href='https://github.com/yetibot/yetibot.core/blob/master/src/yetibot/core/repl.clj'><code>yetibot.core.repl</code></a> for more info.</p><h3 id="linting">Linting</h3><p>Run this from the repo root to lint:</p><pre><code class="bash">codeclimate analyze
</code></pre><h2 id="building&#95;your&#95;first&#95;command">Building your first command</h2><h2 id="command&#95;handling&#95;pipeline">Command handling pipeline</h2><p>This describes an overview of how yetibot takes raw input and passes it through its command handling pipeline.</p><h3 id="raw&#95;input">Raw input</h3><p><code>yetibot.core.handler/handle-raw</code> is passed params from an adapter:</p><ul><li><code>chat-source</code> e.g. <code>{:adapter :irc :room &quot;#clojure&quot;}</code></li><li><code>user</code> e.g. <code>{:name devth, :username devth, :id &#126;devth, :user &#126;devth, :nick devth}</code></li><li><code>event-type</code> one of: <code>:message</code>, <code>:react</code>, <code>:leave</code>, <code>:enter</code>, <code>:sound</code>, <code>:kick</code></li><li><code>body</code> this is the actual text the user wrote. Only <code>event-type</code>s of  <code>:message</code> and <code>:react</code> have a <code>body</code>. Otherwise it is <code>nil</code>. When not <code>nil</code>,  <code>handle-raw</code> checks to see if the <code>body</code> is prefixed with <code>!</code>. If it is,  <code>handle-raw</code> strips the leading <code>!</code> and  <code>yetibot.core.handler/handle-unprased-expr</code> is called with <code>chat-source</code>,  <code>user</code>, and <code>body</code>.</li></ul><h3 id="unparsed&#95;expression&#95;handling">Unparsed expression handling</h3><p>Raw, unparsed expression are passed to <code>yetibot.core.handler/handle-unprased-expr</code>, along with the <code>user</code> and <code>body</code>. <code>handle-unprased-expr</code> sets a <code>binding</code> for the latter 2, then parses and evaluates the expression using <code>yetibot.core.parser/parse-and-eval</code>.</p><h3 id="parsing">Parsing</h3><p><code>yetibot.core.parser</code> is an <a href='https://github.com/Engelberg/instaparse'>Instaparse</a> parser, which fully specifies the yetibot grammar, including arbitrarily-nested subexpressions, piped commands and literals. Once a raw expression is parsed into an AST, it is evaluated using Instaparse's <code>transform</code> helper, which takes a map of AST keys to functions. The important function here is <code>yetibot.core.interpreter/handle-expr</code> which takes any number of individual commands to be reduced using pipe semantics.</p><h3 id="evaluating">Evaluating</h3><p><code>handle-expr</code> literally <code>reduce</code>s its <code>cmds</code> arguments over the <code>yetibot.core.interpreter/pipe-cmds</code>. Each command is evaluated from left to right, and each evaluation output is passed as arguments to the next command. Command output can either be a single value, or a collection of values. This affects the method <code>pipe-cmds</code> will pass it to the next comand:</p><ul><li><strong>Single value</strong>: <code>pipe-cmds</code> will simply append it using  <code>yetibot.core.util/psuedo-format</code>, which is similar to <code>clojure.core/format</code>  except it will append the value at the end of the string if there is not a  <code>%s</code> placeholder present, and if there are <em>multiple</em> <code>%s</code>s present, it will  replace <em>all</em> of them with the value.</li><li><strong>Collection</strong>: <code>pipe-cmds</code> passes the collection as an optional <code>:opts</code> key  in the <code>extra</code> argument to <code>yetibot.core.interpreter/handle-cmd</code>, letting  individual commands do whatever they like with the <code>:opts</code>. For example, many  of the <code>yetibot.core.commands.collections</code> commands require a <code>:opts</code> key as  they primarily operate on collections.</li></ul><p><code>yetibot.core.interpreter/handle-cmd</code> is the function that gets <a href='https://github.com/technomancy/robert-hooke/'>hooked</a> by <code>yetibot.core.hooks</code>. Each command in the <code>yetibot.core.interpreter/hooks</code> collection gets to look at the args and decide whether it can handle the input or not. As soon as a single command handles it, evaluation is complete. If no command handles it, <code>handle-cmd</code> will fallback on google image search.</p><h3 id="command&#95;arguments">Command arguments</h3><p>Use <code>raw all</code> to view all arguments.</p><pre><code class="yetibot">!range 3 | raw all
</code></pre><h4 id="data">Data</h4><h3 id="push&#95;down&#95;operations">Push down operations</h3><p>Yetibot has the ability to look ahead into the command pipeline and optionally consume subsequent commands from a command handler function. In relational algebra this is often referred to as pushing down an operation.</p><p>Consider <code>history | random</code> as an example. The <code>history</code> command looks ahead at the next commands in the pipeline, sees that it's a command it knows how to consume (<code>random</code>), and tells the command execution pipeline to skip it for efficiency and instead handle itself.</p><p>Imagine the default naive method Yetibot would execute if this were not the case:</p><ol><li>Load all history into a data structure</li><li>Pass the data structure to <code>random</code> which calls <code>rand-nth</code> on the collection.   According to the <a href='https://public.yetibot.com/'>public Yetibot dashboard</a> at   the time of writing we have 12,723 entries in the history table. This isn't   that much but you can imagine how slow it'd be as the table continues to   grow.</li></ol><p>The full set of commands that <code>history</code> consumes are defined in <a href='https://github.com/yetibot/yetibot.core/blob/f2e045002e20adccb79adbb84eb12566fc99c51e/src/yetibot/core/commands/history.clj#L8'><code>yetibot.core.commands.history/consumeables</code></a>:</p><pre><code class="clojure">&#40;def consumables #{&quot;head&quot; &quot;tail&quot; &quot;count&quot; &quot;grep&quot; &quot;random&quot;}&#41;
</code></pre><p>See <a href='https://github.com/yetibot/yetibot.core/blob/master/src/yetibot/core/commands/history.clj#L46-L61'>the history command</a> for a full example.</p><h3 id="timeouts">Timeouts</h3><h3 id="testing&#95;commands">Testing commands</h3><ol><li>Using <code>command-execution-info</code></li><li>Mocking with Midje</li></ol><h2 id="working&#95;with&#95;the&#95;database">Working with the database</h2><h2 id="parser">Parser</h2><h2 id="load&#95;order">Load order</h2><p>Yetibot loads itself in a particular order. The database should be initialized and schemas loaded as soon as possible, since many models load themselves based on it. We want to start logging as soon as possible.</p><h3 id="database&#95;namespaces">Database namespaces</h3><p>All database schemas should live in <code>db</code> namespaces:</p><ul><li><code>yetibot.db.&#42;</code></li><li><code>yetibot.core.db.&#42;</code></li><li><code>&#42;.plugins.db.&#42;</code></li></ul><p>The <code>yetibot.core.db</code> namespace will map over these, building up their <code>schema</code>s if available.</p><h3 id="logging">Logging</h3><p><code>start</code> fn is called on <code>yetibot.core.logging</code> to initialize its database-appender.</p><h3 id="chat&#95;adapters">Chat adapters</h3><p>Chat adapters are loaded next. Their <code>start</code> functions are called, which connects to the chat protocol and bootstraps its users into the <code>users</code> model.</p><h3 id="observers&#95;and&#95;commands">Observers and commands</h3><p>Finally, observers and commands are loaded. These typically <code>require</code> models and api namespaces, which may make network or database calls to bootstrap data.</p><h2 id="graphql&#95;api">GraphQL API</h2><p>Yetibot hosts a GraphQL powered API. The public instance is available at <a href='https://public.yetibot.com/graphql'>https://public.yetibot.com/graphql</a>. Try hitting it with <code>curl</code>:</p><pre><code class="bash">curl 'https://public.yetibot.com/graphql' \
  -H 'Accept: application/json' \
  --data 'query=%7Beval&#40;expr%3A%20%22uptime%22&#41;%7D' \
  --compressed
</code></pre><h2 id="web&#95;dashboard">Web dashboard</h2><p>Yetibot hosts a web-based frontend powered by the GraphQL API. See the public instance at <a href='https://public.yetibot.com'>public.yetibot.com</a>.</p><h2 id="ü§î">ü§î</h2><p><article class="message is-info"> <div class="message-header">   <p>Docs didn't answer your question?</p> </div> <div class="message-body">   Ask us in <a href='https://slack.yetibot.com'>Slack</a> or   <a href='https://github.com/yetibot/community/issues/new'>open a new issue</a>   on the <code>community</code> repo. </div> </article></p>
        </div>

        <div class="column toc">
          <ol class="content"><li><a href="#dev_workflow">Dev workflow</a></li><ol><li><a href="#prerequisites">Prerequisites</a></li><ol><li><a href="#leiningen">Leiningen</a></li><li><a href="#postgres">Postgres</a></li><li><a href="#configuration">Configuration</a></li></ol><li><a href="#repl">REPL</a></li><li><a href="#linting">Linting</a></li></ol><li><a href="#building_your_first_command">Building your first command</a></li><li><a href="#command_handling_pipeline">Command handling pipeline</a></li><ol><li><a href="#raw_input">Raw input</a></li><li><a href="#unparsed_expression_handling">Unparsed expression handling</a></li><li><a href="#parsing">Parsing</a></li><li><a href="#evaluating">Evaluating</a></li><li><a href="#command_arguments">Command arguments</a></li><ol><li><a href="#data">Data</a></li></ol><li><a href="#push_down_operations">Push down operations</a></li><li><a href="#timeouts">Timeouts</a></li><li><a href="#testing_commands">Testing commands</a></li></ol><li><a href="#working_with_the_database">Working with the database</a></li><li><a href="#parser">Parser</a></li><li><a href="#load_order">Load order</a></li><ol><li><a href="#database_namespaces">Database namespaces</a></li><li><a href="#logging">Logging</a></li><li><a href="#chat_adapters">Chat adapters</a></li><li><a href="#observers_and_commands">Observers and commands</a></li></ol><li><a href="#graphql_api">GraphQL API</a></li><li><a href="#web_dashboard">Web dashboard</a></li><li><a href="#ü§î">ü§î</a></li></ol>
        </div>
      </div>

      <div id="prev-next">
        
        <a class="button is-warning" href="/user-guide/">&laquo; User Guide</a>
        
        

        
        
        <a class="button is-warning" href="/ops-guide/">Operations Guide &raquo;</a>
        
      </div>
    </div>
  </div>

</section>



    </div>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <strong>Yetibot</strong> by <a href="https://devth.com">Trevor
            Hartman</a> & contributors.
          <br />
          Distributed under the
          <a href="https://opensource.org/licenses/eclipse-1.0.php">
            Eclipse Public License 1.0</a>.
          <br />
          Artwork by
          <a href="http://www.freeformdesign.co/">Freeform Design Co.</a>
          in <strong>Montana</strong>.
          <br />

          This site is continously delivered from
          <a href="https://github.com/yetibot/yetibot.github.io">
             source</a>.
        </p>
      </div>
    </footer>

    <script src="https://cdn.rawgit.com/f/graphql.js/master/graphql.min.js"
            type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <script src="/js/yetibot.js" type="text/javascript" charset="utf-8"></script>
    <script src="/js/highlight.pack.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

